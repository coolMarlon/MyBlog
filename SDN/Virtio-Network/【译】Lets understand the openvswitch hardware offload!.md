 ğŸ’¡ ä¸€ç‚¹æ„Ÿå—ï¼š 1ã€è¿™ç¯‡æ–‡ç« ä¸å¤ªè¡Œï¼Œçœ‹å®Œæ²¡å­¦åˆ°å•¥ï¼Œå¯èƒ½æ˜¯æˆ‘å¤ªèœï¼Œå¾ˆå¤šä¸œè¥¿æ²¡ç†è§£ã€‚ 2ã€å¦å¤–æ”¹ç”¨notionå†™BLOGäº†ï¼Œä¸å¾—ä¸è¯´ï¼ŒçœŸå¥½çœ‹ï¼

åŸæ–‡åœ°å€ï¼šhttps://hareshkhandelwal.blog/2020/03/11/lets-understand-the-openvswitch-hardware-offload/

æœ¬åšå®¢çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªå‚è€ƒæŒ‡å—ï¼Œè§£é‡Šä¸ Ovs ç¡¬ä»¶å¸è½½ + Openstack + Mellanox æ™ºèƒ½ ç½‘å¡ç›¸å…³çš„é…ç½®/æ•…éšœæ’é™¤é—®é¢˜çš„æ‰€æœ‰åŸºç¡€çŸ¥è¯†

è®©æˆ‘ä»¬å¼€å§‹ã€‚

## æ„å»ºæ¨¡å—

ä¸‹å›¾æç»˜äº†ä½¿ç”¨ Openstack éƒ¨ç½² ovs ç¡¬ä»¶å¸è½½æ—¶æ¶‰åŠçš„æ„å»ºå—ã€‚ è‡ª Redhat OSP13ï¼ˆç¤¾åŒºç‰ˆ Queenï¼‰ä»¥æ¥ï¼Œæ­¤åŠŸèƒ½å¯ç”¨ä½œæŠ€æœ¯é¢„è§ˆç‰ˆã€‚

![img](https://pic1.zhimg.com/80/v2-a89a38338c11b7344ad08915decd6c43_720w.png?source=d16d100b)



ç¼–è¾‘

æ·»åŠ å›¾ç‰‡æ³¨é‡Šï¼Œä¸è¶…è¿‡ 140 å­—ï¼ˆå¯é€‰ï¼‰

è®©æˆ‘ä»¬ç†è§£ä»–ä»¬ä¸­çš„æ¯ä¸€ä¸ª

## Nova

Nova è°ƒåº¦ç¨‹åºåœ¨å¤„ç†å¸è½½åŠŸèƒ½æ—¶æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå…¶è¡Œä¸ºä¸ SR-IOV ä¼ é€’ç›¸åŒï¼Œä¾‹å¦‚ç”Ÿæˆã€‚ Nova è°ƒåº¦ç¨‹åºåº”é…ç½®ä¸ºä½¿ç”¨ PciPassthroughFilterï¼ŒNova è®¡ç®—åº”é…ç½®ä¸º passthrough_whitelistã€‚ Os-vif ä¼šæ‰¾å‡ºæ˜ å°„åˆ°æ’å…¥ VM çš„ VF ç«¯å£çš„ä»£è¡¨ç«¯å£åç§°ï¼Œå¹¶å°†ä»£è¡¨ç«¯å£æ’å…¥ br-intã€‚

## Neutron

å¯ç”¨å¸è½½åï¼ŒNIC e-swithcæ¨¡å¼æ›´æ”¹ä¸ºâ€œswitchdevâ€ã€‚ è¿™å°†åœ¨ NIC ä¸Šåˆ›å»ºä»£è¡¨ç«¯å£å¹¶æ˜ å°„/å¯¹åº”äºæ¯ä¸ªåˆ›å»ºçš„ VFã€‚ Representator ç«¯å£è¢«æ’å…¥ä¸»æœºï¼Œå¹¶å°†æ•°æ®åŒ…ä» VF æ¥æ”¶åˆ°å’Œä» VF åˆ°å†…æ ¸äº¤æ¢ã€‚

ä¸ºäº†ä»å¯ç”¨ switchdev çš„ NIC åˆ†é…ç«¯å£ï¼Œéœ€è¦ä½¿ç”¨ç»‘å®šé…ç½®æ–‡ä»¶åˆ›å»º neutron ç«¯å£ï¼Œå…¶ä¸­æåˆ°çš„åŠŸèƒ½å¦‚ä¸‹ã€‚

```
$ openstack port create â€“network private â€“vnic-type=direct â€“binding-profile â€˜{â€œcapabilitiesâ€: [â€œswitchdevâ€]}â€™ direct_port1
```

ç®¡ç†å‘˜åœ¨åˆ›å»ºå®ä¾‹æ—¶ä¼ é€’æ­¤ç«¯å£ä¿¡æ¯ã€‚ä»£è¡¨ç«¯å£ä¸å®ä¾‹ VF æ¥å£ç›¸å…³è”ï¼Œå¹¶æ’å…¥åˆ° ovs æ¡¥ br-int è¿›è¡Œä¸€æ¬¡ ovs æ•°æ®è·¯å¾„å¤„ç†ã€‚

## OVS

åœ¨å¸è½½ç¯å¢ƒä¸­ï¼Œç¬¬ä¸€ä¸ªæ•°æ®åŒ…éå† ovs å†…æ ¸æ•°æ®è·¯å¾„ã€‚ æœ‰å…³å›¾å½¢è¡¨ç¤ºï¼Œè¯·å‚é˜…â€œæ•°æ®åŒ…æ—…ç¨‹â€éƒ¨åˆ†ã€‚ ç¬¬ä¸€æ¬¡éå†ä½¿ ml2 ovs èƒ½å¤Ÿä¸ºå®ä¾‹æµé‡æ‰¾å‡ºä¼ å…¥/ä¼ å‡ºæ•°æ®åŒ…çš„è§„åˆ™ã€‚ ä¸€æ—¦å½¢æˆä¸ç‰¹å®šæµé‡æµæœ‰å…³çš„æ‰€æœ‰æµï¼Œovs å°†ä½¿ç”¨ TC èŠ±å®ç”¨ç¨‹åºåœ¨ NIC ç¡¬ä»¶ä¸Šæ¨é€å’Œç¼–ç¨‹è¿™äº›æµã€‚

æˆ‘ä»¬éœ€è¦åœ¨ ovs ä¸Šåº”ç”¨ä»¥ä¸‹é…ç½®æ‰èƒ½å¯ç”¨ç¡¬ä»¶å¸è½½ã€‚

```
$ sudo ovs-vsctl set Open_vSwitch . other_config:hw-offload=true
```

## TC å­ç³»ç»Ÿ

å½“å¯ç”¨ç¡¬ä»¶å¸è½½æ ‡å¿—æ—¶ï¼ŒOvs ä½¿ç”¨ TC æ•°æ®è·¯å¾„ã€‚ TC Flower æ˜¯ä¸€ä¸ª iproute2 å®ç”¨ç¨‹åºï¼Œç”¨äºåœ¨ç¡¬ä»¶ä¸Šå†™å…¥æ•°æ®è·¯å¾„æµã€‚

æˆ‘ä»¬éœ€è¦åœ¨ ovs ä¸Šåº”ç”¨ä»¥ä¸‹é…ç½®ã€‚ å¦‚æœæœªæ˜ç¡®é…ç½® tc-policyï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤é€‰é¡¹ã€‚

```
$ sudo ovs-vsctl set Open_vSwitch . other_config:tc-policy=both
```

è¿™å°†ç¡®ä¿å½“æµç¨‹è¢«ç¼–ç¨‹æ—¶ï¼Œå®ƒå°†åœ¨ç¡¬ä»¶å’Œè½¯ä»¶æ•°æ®è·¯å¾„ä¸Šè¢«ç¼–ç¨‹ã€‚ å¦‚æœç¡¬ä»¶ç¨‹åºå¤±è´¥ï¼Œæµé‡ä»ç„¶å¯ä»¥é€šè¿‡ tc æ•°æ®è·¯å¾„è¿›è¡Œå¼•å¯¼ï¼Œä½†ä¼šäº§ç”Ÿæ€§èƒ½æˆæœ¬ã€‚

## ç½‘å¡é©±åŠ¨(PF å’Œ VF)

Mellanox ConnectedX-5 ä½¿ç”¨ mlx5_core ä½œä¸ºå…¶ PF å’Œ VF é©±åŠ¨ç¨‹åºã€‚ è¯¥é©±åŠ¨ç¨‹åºé€šå¸¸è´Ÿè´£ç¡¬ä»¶ä¸Šçš„è¡¨åˆ›å»ºã€æµå¤„ç†ã€switchdev é…ç½®ã€å—è®¾å¤‡åˆ›å»ºç­‰ã€‚ devlink å·¥å…·ç”¨äºè®¾ç½® pci è®¾å¤‡çš„æ¨¡å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
$ sudo devlink dev eswitch set pci/0000:03:00.0 mode switchdev
```

## ç½‘å¡é˜²ç«å¢™

NIC å›ºä»¶æ˜¯ä¸€ç§éæ˜“å¤±æ€§å†…å­˜è½¯ä»¶ï¼Œå¹¶åœ¨é‡æ–°å¯åŠ¨åä¿æŒå…¶é…ç½®ã€‚ ä½†æ˜¯ï¼Œå®ƒæ˜¯è¿è¡Œæ—¶å¯ä¿®æ”¹çš„ã€‚ å®ƒé€šå¸¸è´Ÿè´£ç»´æŠ¤è¡¨/è§„åˆ™ã€ä¿®å¤è¡¨ç®¡é“ã€ç¡¬ä»¶èµ„æºç®¡ç†ã€VF åˆ›å»ºã€‚ é™¤äº†é©±åŠ¨ç¨‹åºå¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å›ºä»¶æ”¯æŒæ‰èƒ½ä½¿ä»»ä½•åŠŸèƒ½é¡ºåˆ©è¿è¡Œã€‚

æˆ‘ä»¬éœ€è¦åœ¨æ¥å£ä¸Šåº”ç”¨ä»¥ä¸‹é…ç½®æ¥å¯ç”¨ç«¯å£çº§åˆ«çš„tcèŠ±æ¨æµç¼–ç¨‹ã€‚

```
$ sudo ethtool -K enp3s0f0 hw-tc-offload on
```

## åŒ…çš„æ—…ç¨‹

![img](https://picx.zhimg.com/80/v2-684c49c7877d5925655ba5022625e79e_720w.png?source=d16d100b)



ç¼–è¾‘åˆ‡æ¢ä¸ºå±…ä¸­

æ·»åŠ å›¾ç‰‡æ³¨é‡Šï¼Œä¸è¶…è¿‡ 140 å­—ï¼ˆå¯é€‰ï¼‰

æ³¨æ„ï¼š

- è¿™é‡Œè¯´æ˜çš„æµç¨‹åªæ˜¯ä¸€ä¸ªä¾‹å­ã€‚ å®é™…æµå°†åŒ…å«æ›´å¤šåŒ¹é…å’Œæ“ä½œå­—æ®µï¼Œå¦‚ vxlan éš§é“ã€vlan encap/decap ç­‰ã€‚
- ä¸€æ—¦åœ¨ NIC ä¸Šå¯¹æµè¿›è¡Œç¼–ç¨‹ï¼ŒVLAN å’Œ VxLAN çš„æ•°æ®åŒ…æµå°†ä¿æŒä¸å˜ã€‚ åœ¨ VxLAN çš„æƒ…å†µä¸‹ï¼Œbr-tun å°†å¤„ç† VxLAN ä¼ è¾“å±‚æŠ¥å¤´çš„å°è£…/å»å°è£…ä»¥è¿›è¡Œç¬¬ 1 ä¸ªæ•°æ®åŒ…å¤„ç†ã€‚ã€ã€
- å¯¹äºæ¯ä¸ªäº¤é€šæ–¹å‘ï¼Œéƒ½ä¼šå¯¹æµé‡è¿›è¡Œç¼–ç¨‹ã€‚ IEã€‚ æµé‡å‘é€/æ¥æ”¶å®ä¾‹å°†ä¸ºä¸¤ä¸ªæ–¹å‘ç¼–ç¨‹ 2 ä¸ªæµã€‚ å¦‚æœä¸æ”¯æŒè¯¥æ“ä½œï¼Œåˆ™æ— æ³•å¸è½½è¯¥è§„åˆ™ã€‚
- ç±»ä¼¼åœ°ï¼Œå½“æ— æ³•è¯†åˆ«å­—æ®µæ—¶ï¼Œæ— æ³•å¸è½½è§„åˆ™ã€‚ æœ‰å…³æ”¯æŒçš„åˆ†ç±»å™¨å’Œæ“ä½œçš„åˆ—è¡¨ï¼Œè¯·è®¿é—®æ­¤å¤„ã€‚

ä»ä¸‹é¢çš„æµå‰–æéƒ¨åˆ†æ˜¾ç¤ºçš„å®ä¾‹ä¸­æ•è· ping æµé‡çš„ç¤ºä¾‹è¾“å‡ºã€‚

## åŸºæœ¬æ•…éšœæ’é™¤ï¼š

### åŠŸèƒ½æ”¯æŒçš„ç‰ˆæœ¬

Linux Kernel >= 4.13

Open vSwitch >= 2.8

openstack >= Pike version

iproute >= 4.12

Mellanox NICs FW

FW ConnectX-5: >= 16.21.0338

FW ConnectX-4 Lx: >= 14.21.0338

æ³¨æ„ï¼šMellanox ConnectX-4 NIC ä»…æ”¯æŒ VLAN å¸è½½ã€‚ Mellanox ConnectX-4 Lx/ConnectX-5 NIC æ”¯æŒ VLAN/VXLAN å¸è½½ã€‚

[å½“å‰æ”¯æŒçš„åˆ†ç±»å™¨ï¼ˆOvs 2.11ï¼‰](https://www.notion.so/a7e7403abb5e474f8df257d0dbf8118e)

![img](https://picx.zhimg.com/80/v2-335362629f2aee9c7e91b0f0280a611d_720w.png?source=d16d100b)



ç¼–è¾‘åˆ‡æ¢ä¸ºå±…ä¸­

æ·»åŠ å›¾ç‰‡æ³¨é‡Šï¼Œä¸è¶…è¿‡ 140 å­—ï¼ˆå¯é€‰ï¼‰

## æµè§£å‰–

å¸è½½æµåŠŸèƒ½ä¸ç¡¬ä»¶äº¤æ¢æœº/è·¯ç”±å™¨ä½¿ç”¨ ASIC èŠ¯ç‰‡ç»„æ‰€åšçš„éå¸¸ç›¸ä¼¼ã€‚ ä¸€æ—¦åœ¨ ASIC ä¸Šåšå‡ºè·¯ç”±/è½¬å‘å†³ç­–å¹¶å†™å…¥ï¼ŒASIC å°±ä¼šå¤„ç†ä¼ å…¥æ•°æ®åŒ…çš„åŒ¹é…å’Œæ“ä½œï¼Œå¹¶æä¾›çº¿é€Ÿå¤„ç†ã€‚ è·¯ç”±å™¨/äº¤æ¢æœºå¯ä»¥åœ¨éœ€è¦è¿›è¡Œæ­¤ç±»è°ƒè¯•æ—¶è¿›å…¥ ASIC å¤–å£³å¹¶æ‰¾å‡ºå…¶è¡¨æ¡ç›®ã€‚

çœ‹çœ‹ä¸‹é¢ä» cumulus linux è¿è¡Œäº¤æ¢æœºä¸­è·å–çš„ Broadcom èŠ¯ç‰‡ç»„è¾“å‡ºã€‚

```
root@dni-7448-26:~# cl-bcmcmd l2 show
mac=00:02:00:00:00:08 vlan=2000 GPORT=0x2 modid=0 port=2/xe1
mac=00:02:00:00:00:09 vlan=2000 GPORT=0x2 modid=0 port=2/xe1 Hit
```

ä½†æ˜¯ï¼ŒNIC ä¾›åº”å•†ä¸æä¾›æ­¤ç±»è®¿é—®ï¼Œå¹¶è®©ç–‘éš¾è§£ç­”äººå‘˜çŒœæµ‹åœ¨æœªå¸è½½æµé‡æ—¶ NIC ç¡¬ä»¶å¯èƒ½å‡ºç°ä»€ä¹ˆé—®é¢˜ã€‚

æœ‰äº†è¿™ä¸ªé™åˆ¶ï¼Œè¿è¥å•†å°±ä¿¡ä»» ovs å’Œ tc æ¥ç¡®ä¿æµç¨‹åˆ¶å®šç¬¦åˆå‰å‘æ”¿ç­–å¹¶æ¨é€åˆ°ç¡¬ä»¶ã€‚

è®©æˆ‘ä»¬å‰–æå–è‡ª ovs æ•°æ®è·¯å¾„è¡¨çš„ç¤ºä¾‹æµç¨‹å¹¶å°è¯•ç†è§£å®ƒã€‚

ä¸‹é¢æ˜¯ä¸€å¯¹äº¤æ˜“æµã€‚ æ¥è‡ªå¤–éƒ¨ç½‘ç»œçš„æ•°æ®åŒ…åˆ°è¾¾ç»‘å®šæ¥å£ï¼ˆPFs ç»‘å®šï¼‰å¹¶æ¨é€åˆ°ä»£è¡¨ç«¯å£ï¼ˆæœ€ç»ˆè¿›å…¥ VMï¼‰çš„ç¬¬ä¸€ä¸ªæµï¼Œè€Œæ¥è‡ªä»£è¡¨ç«¯å£ï¼ˆæ¥è‡ª VM çš„å‡ºå£ï¼‰çš„æ•°æ®åŒ…é€šè¿‡ç»‘å®šç¦»å¼€çš„ç¬¬äºŒä¸ªæµã€‚

```
ufid:6ef8818a-17df-4714-9010-1203cbc163c9, skb_priority(0/0),skb_mark(0/0),in_port(bond-pf),packet_type(ns=0/0,id=0/0),eth(src=fa:16:3e:51:c3:7c,dst=f8:f2:1e:03:bf:e4),eth_type(0x8100),vlan(vid=398,pcp=0),encap(eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no)), packets:11, bytes:1078, used:0.080s, offloaded:yes, dp:tc, actions:pop_vlan,eth3
ufid:724ad8e3-2f49-4aa9-8ea7-b5331fba2a1f, skb_priority(0/0),skb_mark(0/0),in_port(eth3),packet_type(ns=0/0,id=0/0),eth(src=f8:f2:1e:03:bf:e4,dst=fa:16:3e:51:c3:7c),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:11, bytes:1122, used:0.080s, offloaded:yes, dp:tc, actions:push_vlan(vid=398,pcp=0),bond-pf
```

- Ufidï¼šå”¯ä¸€æµæ ‡è¯†ç¬¦
- skb_priorityï¼šè¿™ä¸ª qdisc å­—æ®µä¸æ˜¯å†™åœ¨ç¡¬ä»¶ä¸Šçš„ã€‚ å®ƒæœ‰ä¸€ä¸ªæ©ç å€¼ /0ï¼Œè¿™ä½¿å®ƒåœ¨å¤„ç†æ•°æ®åŒ…æ—¶å¯ä»¥å¿½ç•¥ã€‚
- skb_markï¼šè¿™ä¸ª qdisc å­—æ®µä¸æ˜¯å†™åœ¨ç¡¬ä»¶ä¸Šçš„ã€‚ å®ƒæœ‰ä¸€ä¸ªæ©ç å€¼ /0ï¼Œè¿™ä½¿å®ƒåœ¨å¤„ç†æ•°æ®åŒ…æ—¶å¯ä»¥å¿½ç•¥ã€‚
- in_port: ä¼ å…¥æ•°æ®åŒ…çš„ç«¯å£
- Packet_typeï¼šovsæ”¯æŒçš„åŒ…ç±»å‹æœ‰å¾ˆå¤šã€‚ ç„¶è€Œï¼Œè™½ç„¶å¸è½½è¿™ä¸æ˜¯å†™åœ¨ç¡¬ä»¶ä¸Šï¼Œå®ƒçš„æ©ç å€¼ä¹Ÿä½¿å®ƒåœ¨å¤„ç†æ•°æ®åŒ…æ—¶å…·æœ‰ç›¸å…³æ€§ã€‚
- eth_typeï¼šoffload æ”¯æŒæ‰€æœ‰ eth_type å¹¶**å†™å…¥ç¡¬ä»¶**ã€‚ ç„¶è€Œï¼Œé™¤äº† vlan å’Œ mpls ä¹‹å¤–ï¼Œæ‰€æœ‰å…¶ä»– eth_type çš„å†…éƒ¨å­—æ®µéƒ½æ²¡æœ‰ç”¨äºåŒ¹é…æ•°æ®åŒ…ã€‚ è½¬å‘ä»…ç”± eth_type è€Œä¸æ˜¯å…¶ä»–å­—æ®µå®Œæˆã€‚ IEã€‚ å¦‚æœ eth_type = 0x0806ï¼Œåˆ™ arp æ ‡å¤´ä¸ç”¨äºåŒ¹é…æ“ä½œã€‚
- Eth (src,dst)ï¼šäºŒå±‚ä»¥å¤ªç½‘æºå’Œmacåœ°å€
- vlanï¼švlan id å’Œ pcpï¼ˆpriority code pointsï¼‰
- ipv4(src/dst)ï¼šå› ä¸ºè¿™é‡Œçš„æ©ç æ˜¯/0ï¼Œè¿™äº›è¢«å¿½ç•¥ï¼Œä»»ä½•ipv4 srcã€dståŒ…è¢«è¿™ä¸ªæµå¤„ç†ã€‚
- ipv4(proto,tos,tt,frag)ï¼šä¸‹ä¸€ä¸ªå¤´éƒ¨çš„åè®®ï¼ŒTos å­—èŠ‚ï¼Œç”Ÿå­˜æ—¶é—´å’Œç‰‡æ®µåç§»é‡ã€‚
- Statisticsï¼šè¿™é‡Œçš„æ•°å­—æ˜¯ä»æ¥å£ä¸­æå–çš„ã€‚
- Usedï¼šå¸è½½åçš„æ—¶é—´
- Offloadedï¼šovsç«¯ç¡®è®¤
- dp: tc: â€“ è¿™é‡Œä½¿ç”¨çš„æ•°æ®è·¯å¾„æ˜¯ tc

è®©æˆ‘ä»¬çœ‹ä¸€æ¡ARPæµ

```
ufid:31ec10fa-ffdc-454b-867f-f673dae77ea6, skb_priority(0/0),skb_mark(0/0),in_port(bond-pf),packet_type(ns=0/0,id=0/0),eth(src=fa:16:3e:51:c3:7c,dst=f8:f2:1e:03:bf:e4),eth_type(0x8100),vlan(vid=398,pcp=0),encap(eth_type(0x0806),arp(sip=0.0.0.0/0.0.0.0,tip=0.0.0.0/0.0.0.0,op=0/0,sha=00:00:00:00:00:00/00:00:00:00:00:00,tha=00:00:00:00:00:00/00:00:00:00:00:00)), packets:1, bytes:56, used:4.950s, offloaded:yes, dp:tc, actions:pop_vlan,eth3
ufid:7329344d-b5f9-4b03-b26a-a9c7318b24b7, skb_priority(0/0),skb_mark(0/0),in_port(eth3),packet_type(ns=0/0,id=0/0),eth(src=f8:f2:1e:03:bf:e4,dst=fa:16:3e:51:c3:7c),eth_type(0x0806),arp(sip=0.0.0.0/0.0.0.0,tip=0.0.0.0/0.0.0.0,op=0/0,sha=00:00:00:00:00:00/00:00:00:00:00:00,tha=00:00:00:00:00:00/00:00:00:00:00:00), packets:0, bytes:0, used:5.150s, offloaded:yes, dp:tc, actions:push_vlan(vid=398,pcp=0),bond-pf
```

åœ¨è¿™é‡Œï¼Œæ•´ä¸ª **arp** å¤´ï¼ˆå‘é€æ–¹ ip/ç¡¬ä»¶åœ°å€ã€ç›®æ ‡ ip/ç¡¬ä»¶åœ°å€ï¼‰éƒ½ç”¨ 0 æ©ç ï¼Œå› æ­¤åªåº”ä½¿ç”¨ eth_type=0x086 æ¥åšå‡ºå†³ç­–å¹¶å¸è½½åˆ°ç¡¬ä»¶ã€‚

ä»¥ä¸‹æ˜¯ VxLAN çš„å¸è½½æµã€‚

```
ufid:d56153f3-f8c7-4e8a-a6ce-3ddeb73cf27a, skb_priority(0/0),tunnel(tun_id=0x3d,src=10.10.147.101,dst=10.10.147.104,ttl=0/0,tp_dst=4789,flags(+key)),skb_mark(0/0),in_port(vxlan_sys_4789),packet_type(ns=0/0,id=0/0),eth(src=fa:16:3e:45:a9:e2,dst=f8:f2:1e:03:bf:e6),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:19, bytes:1862, used:0.080s, offloaded:yes, dp:tc, actions:eth0
ufid:3bcda9c2-2d36-4692-82c2-aa631f015560, skb_priority(0/0),skb_mark(0/0),in_port(eth0),packet_type(ns=0/0,id=0/0),eth(src=f8:f2:1e:03:bf:e6,dst=fa:16:3e:45:a9:e2),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0x3,ttl=0/0,frag=no), packets:18, bytes:2736, used:0.090s, offloaded:yes, dp:tc, actions:set(tunnel(tun_id=0x3d,src=10.10.147.104,dst=10.10.147.101,ttl=64,tp_dst=4789,flags(key))),vxlan_sys_4789
```

- éš§é“ç±»å‹å–å†³äºæ¥å£å°è£…çš„ç±»å‹ã€‚ å®ƒæ”¯æŒ VXLAN / NVGRE / RAW å’Œ GENEVEã€‚
- flags(key) è¢«å¿½ç•¥å¹¶ä¸”ä¸ä¼šå¸è½½åˆ°ç¡¬ä»¶

### ç³»ç»ŸéªŒè¯

- ç¡®ä¿åœ¨ç³»ç»Ÿä¸Šå¯ç”¨ SR-IOV å’Œ VT-dã€‚
- åœ¨ Linux ä¸­é€šè¿‡å°† intel_iommu=on æ·»åŠ åˆ°å†…æ ¸å‚æ•°æ¥å¯ç”¨ IOMMUï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨ GRUBã€‚

### Debugs

Ovs è°ƒè¯•ç›®å‰æ²¡æœ‰å¸®åŠ©ã€‚ å¢å¼ºæµç¼–ç¨‹çš„å¯è°ƒè¯•æ€§ï¼Œä½†å·²åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­ä¿®å¤ã€‚ è™½ç„¶æˆ‘ä»¬å¯ä»¥åœ¨ ovs ä¸Šå¯ç”¨è°ƒè¯•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
$ ovs-appctl vlog/set dpif_netlink:file:DBG;
```

æ—¥å¿—æ‰“å°åœ¨ **/var/log/openvswitch/ovs-vswitchd.log**.

ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯å¤±è´¥çš„æµç¼–ç¨‹çš„æ•è·ã€‚

```
less /var/log/openvswitch/ovs-vswitchd.log | grep -Ei â€œERR|syndromeâ€
2019-02-19T12:48:46.126Z|00001|dpif_netlink(handler1)|ERR|failed to offload flow: Operation not supported
```

å¹¶è¡Œæ£€æŸ¥ ovsdb æ—¥å¿—ä¹Ÿä¼šæœ‰æ‰€å¸®åŠ©ã€‚ å®ƒä»¬ä½äº /var/log/openvswitch/ovsdb-server.log

Mellanox æä¾›äº†ä¸€ä¸ªç³»ç»Ÿä¿¡æ¯è„šæœ¬ï¼Œå®ƒé€šå¸¸ä»ç³»ç»Ÿä¸­æ•è·æ‰€æœ‰å¿…éœ€çš„ä¿¡æ¯ã€‚ å®ƒå¯ä»¥åœ¨

https://github.com/Mellanox/linux-sysinfo-snapshot/blob/master/sysinfo-snapshot.py

å¹¶ä¸”å¯ä»¥ä½œä¸º

```
# ./sysinfo-snapshot.py â€“asap â€“asap_tc â€“ibdiagnet â€“openstack
```

æ³¨æ„ï¼šå¦‚æœæ“ä½œä¸å—æ”¯æŒï¼Œåˆ™æ— æ³•å¸è½½è§„åˆ™ã€‚ ç±»ä¼¼åœ°ï¼Œå½“æ— æ³•è¯†åˆ«å­—æ®µæ—¶ï¼Œæ— æ³•å¸è½½è§„åˆ™ã€‚

### CLIs:

```
$ ovs-dpctl dump-flows -m type=offloaded
$ tc filter show dev ens1_0 ingress
$ tc -s filter show dev ens1_0 ingress
$ tc monitor
```

Ethtool æä¾›æ›´å¤šç»†èŠ‚ Tov view number of channels:  **ethtool -l <uplink representor>** To check Statistics: **ethtool -I <uplink/VFs>** To see driver Information: **ethtool -i <uplink rep>** To check ring sizes: **ethtool -g <uplink rep>** Enabled features: **ethtool -k <uplink/VFs>**

åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£è¡¨ç«¯å£å’Œ PF ç«¯å£ä½¿ç”¨ tcpdump æ£€æŸ¥æµé‡ã€‚

### Notes

- VF é“¾æ¥çŠ¶æ€çš„ç®¡ç†æ“ä½œç”± VF ä»£è¡¨é“¾æ¥çŠ¶æ€æ§åˆ¶ã€‚ è¿™æ„å‘³ç€ï¼Œå¯¹ä»£è¡¨ç«¯å£é“¾æ¥çŠ¶æ€çš„ä»»ä½•æ›´æ”¹éƒ½ä¼šå½±å“ VF çš„é“¾æ¥çŠ¶æ€ã€‚
- Representator ç«¯å£ç»Ÿè®¡æ•°æ®ä¹Ÿæä¾›äº† VF çš„ç»Ÿè®¡æ•°æ®ã€‚

### é™åˆ¶

â€œopenvswitchâ€é˜²ç«å¢™é©±åŠ¨ç¨‹åºä¸èƒ½ä¸å¸è½½ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºå¸è½½è·¯å¾„ä¸­ä¸æ”¯æŒæµçš„è¿æ¥è·Ÿè¸ªå±æ€§ã€‚ æ”¯æŒé»˜è®¤çš„â€œiptables_hybridâ€æˆ–â€œnoneâ€ã€‚ è¡¥ä¸å·²åˆå¹¶åˆ° Ovs 2.13 ä»¥æ”¯æŒè¿æ¥è·Ÿè¸ªã€‚